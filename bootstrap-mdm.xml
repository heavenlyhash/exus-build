<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ant-project>
<project name="ExultantBuildCommon-mdm" basedir=".">
	<description>
		Bootstrap utils and wrappers for common mdm uses, to help dropship your project onto unprepared shores.
	</description>


	<!--
		Recommended copypasta for bootstrapping the bootstrap:

		<exec executable="git" failonerror="true">
			<arg value="submodule"/>
			<arg value="update"/>
			<arg value="--init"/>
			<arg value="lib/exus-build"/>
		</exec>
		<import file="lib/exus-build/build-exultant.xml"/>
		<import file="lib/exus-build/bootstrap-mdm.xml"/>

	-->


	<available property="mdm.available" file="mdm" filepath="${env.PATH}"/>
	<target name="-bootstrap-mdm" unless="mdm.available">
		<!--
			Check for a locally available mdm executable; fetch mdm binaries if nothing's available.
			Currently pegged to a version number because there's no handily available "lastest/" link.

			This will not do the "Right Thing"(tm) if there's some other executable called `mdm` on
			the system which isn't the one we meant.
		-->
		<property name="mdm.version" value="v2.14.1" />
		<property name="mdm.url" value="https://raw.github.com/mdm-releases/mdm-releases/master/" />
		<property name="mdm.dir" value="${user.home}/.mdm/installs/${mdm.version}/" />
		<mkdir dir="${mdm.dir}" />
		<get
			src="${mdm.url}/${mdm.version}/mdm"
			dest="${mdm.dir}" skipexisting="true" verbose="true"
		/>
		<chmod file="${mdm.dir}/mdm" perm="+x"/>
		<get
			src="${mdm.url}/${mdm.version}/mdm.jar"
			dest="${mdm.dir}" skipexisting="true" verbose="true"
		/>
		<chmod file="${mdm.dir}/mdm.jar" perm="+x"/>
	</target>


	<target name="-bootstrap-mdm-modules" depends="-bootstrap-mdm">
		<!--
			Do an mdm-update, which will fetch all dependency modules.
		-->
		<!--
			Implementation detail: note the use of 'env' vars; assumes build-exultant.xml already loaded,
			or someone else put env there; otherwise we'll fail to see existing $PATH.
		-->
		<exec executable="mdm" vmlauncher="false" failonerror="true">
			<env key="PATH" path="${env.PATH}:${mdm.dir}"/>
			<arg value="--version"/>
		</exec>
		<echo>mdm reporting in.  fetching dependencies; this may take a few minutes depending on your internet connection.</echo>
		<exec executable="mdm" vmlauncher="false" failonerror="true">
			<env key="PATH" path="${env.PATH}:${mdm.dir}"/>
			<arg value="update"/>
		</exec>
	</target>
</project>
